# M3: Agent

## Summary
Claude blob character renders, moves to file locations, shows thought bubbles and tool icons. The agent represents Claude Code's activity in the 3D scene.

## Dependencies
- Requires: M1 (WebSocket events), M2 (terrain positions for navigation)
- Blocks: M4

## Agent Event Flow

```
Claude Code -> Hook -> POST /api/events -> AgentService -> WebSocket -> Swift Client
```

1. Claude uses a tool (e.g., Read)
2. Hook fires, POSTs to `/api/events`
3. Backend updates AgentState, maps file path to 3D coordinates
4. Backend broadcasts `agent_event` via WebSocket
5. Swift client receives event, moves agent to target position

## API Contract

### AgentEvent (WebSocket message)
```json
{
  "type": "agent_event",
  "agent_id": "session-abc123",
  "event_type": "move",
  "target_path": "/src/index.ts",
  "target_position": { "x": 2.5, "y": 5.7, "z": 16.2 },
  "thought": "Reading index.ts to understand exports",
  "tool_name": "Read",
  "timestamp": 1706536800000
}
```

### AgentSpawn (WebSocket message)
```json
{
  "type": "agent_spawn",
  "agent_id": "session-abc123",
  "position": { "x": 0.0, "y": 0.0, "z": 0.0 },
  "color": "#e07850"
}
```

### AgentDespawn (WebSocket message)
```json
{
  "type": "agent_despawn",
  "agent_id": "session-abc123"
}
```

## Backend Tasks

| ID | Task | File | Status |
|----|------|------|--------|
| M3.B1 | Create AgentState class | `app/services/agent.py` | ğŸ”² |
| M3.B2 | Create AgentEvent schema | `app/schemas/events.py` | ğŸ”² |
| M3.B3 | Create AgentSpawn schema | `app/schemas/events.py` | ğŸ”² |
| M3.B4 | Store active agents by session_id | `app/services/agent.py` | ğŸ”² |
| M3.B5 | Process hook events to update agent state | `app/services/agent.py` | ğŸ”² |
| M3.B6 | Map file paths to 3D coordinates | `app/services/agent.py` | ğŸ”² |
| M3.B7 | Generate thought text from tool context | `app/services/agent.py` | ğŸ”² |
| M3.B8 | Broadcast agent_event via WebSocket | `app/services/agent.py` | ğŸ”² |
| M3.B9 | Write tests for agent state | `tests/test_agent.py` | ğŸ”² |
| M3.B10 | Write tests for event processing | `tests/test_agent.py` | ğŸ”² |

## Frontend Tasks

| ID | Task | File | Status |
|----|------|------|--------|
| M3.S1 | Create AgentNode (Claude blob body) | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S2 | Add square eyes to agent | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S3 | Add stubby legs to agent | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S4 | Add glow beneath agent | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S5 | Implement walk animation (body bob, leg cycle) | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S6 | Implement idle animation (breathing pulse) | `Sources/Scene/Nodes/AgentNode.swift` | ğŸ”² |
| M3.S7 | Create ThoughtBubbleNode | `Sources/Scene/Nodes/ThoughtBubbleNode.swift` | ğŸ”² |
| M3.S8 | Create ToolIconNode | `Sources/Scene/Nodes/ToolIconNode.swift` | ğŸ”² |
| M3.S9 | Handle agent_event messages | `Sources/Scene/TerrainScene.swift` | ğŸ”² |
| M3.S10 | Move agent to target position | `Sources/Scene/TerrainScene.swift` | ğŸ”² |
| M3.S11 | Update thought bubble text | `Sources/Scene/TerrainScene.swift` | ğŸ”² |

## Visual Specs

### AgentNode (Claude Blob)

**Body:**
- Shape: SCNBox 4W Ã— 3H Ã— 3D
- Chamfer radius: 0.4 (rounded corners)
- Color: `#e07850` (coral/orange)
- Material: Slightly emissive

**Eyes:**
- Shape: SCNBox 0.7 Ã— 0.7 Ã— 0.1
- Color: Black (`#000000`)
- Position: Upper third of front face
- Spacing: 0.8 units apart

**Legs:**
- Shape: SCNBox 0.6 Ã— 1.2 Ã— 0.6
- Color: `#c06040` (darker coral)
- Position: 4 corners at bottom of body
- Inset: 0.3 from body edges

**Glow:**
- Shape: Circular plane beneath
- Color: `#e07850` at 30% opacity
- Radius: 3.0 units
- Y offset: 0.1 above ground

### Walk Animation
- **Body bob:** Y oscillates Â±0.2 over 0.3s
- **Leg cycle:** Alternate pairs move up/down Â±0.3
- **Speed:** Tied to movement distance

### Idle Animation
- **Breathing:** Scale pulses 1.0 â†’ 1.02 â†’ 1.0 over 2s
- **Eye blink:** Occasional (every 3-5s)

### ThoughtBubbleNode
- **Background:** Rounded rect, white at 90% opacity
- **Text:** SF Mono, 10pt, dark gray
- **Position:** Above agent head, offset Y+4
- **Max width:** 200pt, word wrap
- **Fade:** Disappears after 5s of no update

### ToolIconNode
- **Icons:** Read (ğŸ“–), Write (âœï¸), Edit (ğŸ”§), Bash (âš¡), Grep (ğŸ”), Glob (ğŸ“)
- **Size:** 1.5 Ã— 1.5 units
- **Position:** Floating above agent, offset Y+3
- **Animation:** Fade in on PreToolUse, fade out on PostToolUse

## Thought Generation

Backend generates thoughts from tool context:

| Tool | Input | Thought |
|------|-------|---------|
| Read | `{"file_path": "/src/index.ts"}` | "Reading index.ts" |
| Write | `{"file_path": "/src/new.ts"}` | "Writing new.ts" |
| Edit | `{"file_path": "/src/app.ts"}` | "Editing app.ts" |
| Bash | `{"command": "npm test"}` | "Running: npm test" |
| Grep | `{"pattern": "TODO"}` | "Searching for: TODO" |
| Glob | `{"pattern": "**/*.ts"}` | "Finding: **/*.ts" |

## Tests

### Backend
```bash
cd services/api && uv run pytest tests/test_agent.py -v
```

### Frontend
```bash
cd apps/macos-client && swift test
```

## Acceptance Criteria
- [ ] Claude blob renders with correct proportions and color
- [ ] Eyes and legs are visible
- [ ] Glow appears beneath agent
- [ ] Agent moves smoothly to file positions
- [ ] Walk animation plays during movement
- [ ] Idle animation plays when stationary
- [ ] Thought bubble shows current action
- [ ] Thought bubble fades after inactivity
- [ ] Tool icons appear/disappear with tool use
- [ ] Multiple events in quick succession are handled

## PRs
- Backend: [link when created]
- Frontend: [link when created]
