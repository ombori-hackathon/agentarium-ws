# M2: Terrain

## Summary
Folders render as wireframe pyramids, files as small cubes. Positions are calculated based on directory structure depth and file count.

## Dependencies
- Requires: M1 (WebSocket + filesystem endpoint)
- Blocks: M4

## Elevation Formula

```
elevation = (depth Ã— 3.0) + log(file_count + 1) Ã— 2.0
```

- `depth`: How deep the folder is in the tree (root = 0)
- `file_count`: Number of files directly in the folder
- Root folders start at ground level
- Deeper folders are higher
- Folders with more files are slightly higher

## Coordinate Calculation

Folders are positioned in a spiral pattern from the center:
```python
angle = folder_index * (2 * PI / total_folders_at_depth)
radius = depth * 15  # Spread out by depth
x = cos(angle) * radius
z = sin(angle) * radius
y = elevation
```

Files are positioned around their parent folder:
```python
file_angle = file_index * (2 * PI / total_files_in_folder)
file_radius = 3
x = parent_x + cos(file_angle) * file_radius
z = parent_z + sin(file_angle) * file_radius
y = parent_y + 0.5  # Slightly above folder base
```

## API Contract Update

### GET `/api/filesystem?path=...`

**Response (updated with positions):**
```json
{
  "root": "/Users/ross/Code/phystack-web",
  "folders": [
    {
      "path": "/src",
      "name": "src",
      "depth": 1,
      "file_count": 5,
      "position": { "x": 0.0, "y": 5.2, "z": 15.0 },
      "height": 4.0
    }
  ],
  "files": [
    {
      "path": "/src/index.ts",
      "name": "index.ts",
      "folder": "/src",
      "size": 1234,
      "position": { "x": 2.5, "y": 5.7, "z": 16.2 }
    }
  ],
  "scanned_at": "2026-01-29T12:00:00Z"
}
```

## Backend Tasks

| ID | Task | File | Status |
|----|------|------|--------|
| M2.B1 | Create Position schema | `app/schemas/filesystem.py` | ðŸ”² |
| M2.B2 | Implement elevation formula | `app/services/terrain.py` | ðŸ”² |
| M2.B3 | Implement spiral coordinate layout | `app/services/terrain.py` | ðŸ”² |
| M2.B4 | Calculate positions for folders | `app/services/terrain.py` | ðŸ”² |
| M2.B5 | Calculate positions for files | `app/services/terrain.py` | ðŸ”² |
| M2.B6 | Integrate terrain service with filesystem endpoint | `app/routers/filesystem.py` | ðŸ”² |
| M2.B7 | Write tests for elevation formula | `tests/test_terrain.py` | ðŸ”² |
| M2.B8 | Write tests for coordinate calculation | `tests/test_terrain.py` | ðŸ”² |

## Frontend Tasks

| ID | Task | File | Status |
|----|------|------|--------|
| M2.S1 | Create FolderNode (wireframe pyramid) | `Sources/Scene/Nodes/FolderNode.swift` | ðŸ”² |
| M2.S2 | Add glow effect to FolderNode | `Sources/Scene/Nodes/FolderNode.swift` | ðŸ”² |
| M2.S3 | Create FileNode (small cube) | `Sources/Scene/Nodes/FileNode.swift` | ðŸ”² |
| M2.S4 | Parse FilesystemLayout positions | `Sources/Scene/TerrainScene.swift` | ðŸ”² |
| M2.S5 | Spawn FolderNodes at calculated positions | `Sources/Scene/TerrainScene.swift` | ðŸ”² |
| M2.S6 | Spawn FileNodes around folders | `Sources/Scene/TerrainScene.swift` | ðŸ”² |
| M2.S7 | Add folder labels (floating text) | `Sources/Scene/Nodes/LabelNode.swift` | ðŸ”² |
| M2.S8 | Implement distance fog | `Sources/Scene/TerrainScene.swift` | ðŸ”² |

## Visual Specs

### FolderNode (Wireframe Pyramid)
- **Shape:** 4-sided pyramid, wireframe only
- **Base size:** `2.0 + log(file_count + 1)` (scales with content)
- **Height:** `height` from API (based on file count)
- **Color:** `#00ff88` (green glow)
- **Line width:** 2.0
- **Glow:** Subtle emissive material

### FileNode (Cube)
- **Shape:** Small cube
- **Size:** 0.3 Ã— 0.3 Ã— 0.3
- **Color:** `#00ff88` at 60% opacity
- **No wireframe:** Solid with slight transparency

### LabelNode (Floating Text)
- **Font:** SF Mono, 12pt
- **Color:** `#00ff88`
- **Position:** Above folder pyramid apex
- **Billboard:** Always faces camera

### Fog
- **Start distance:** 50 units
- **End distance:** 150 units
- **Color:** Match background `#0a0a12`

## Tests

### Backend
```bash
cd services/api && uv run pytest tests/test_terrain.py -v
```

### Frontend
```bash
cd apps/macos-client && swift test
```

## Acceptance Criteria
- [ ] Folders render as wireframe pyramids at correct positions
- [ ] Pyramid size scales with file count
- [ ] Files render as small cubes near their parent folder
- [ ] Folder names appear as floating labels
- [ ] Distant objects fade into fog
- [ ] Colors match spec (`#00ff88` green glow)
- [ ] Elevation formula produces visually distinct levels

## PRs
- Backend: [link when created]
- Frontend: [link when created]
